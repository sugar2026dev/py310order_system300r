<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最终OCR测试</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { background: #f5f5f5; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .upload-area { border: 2px dashed #007bff; padding: 40px; text-align: center; border-radius: 10px; cursor: pointer; margin: 20px 0; }
        .upload-area:hover { background: #e9f5ff; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .result { margin-top: 20px; padding: 20px; background: white; border-radius: 5px; border: 1px solid #ddd; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <h1>最终OCR测试</h1>
    <p>这个页面使用相对路径调用Django接口，避免跨域问题。</p>
    
    <div class="container">
        <div class="info">
            <h3>推荐方案：通过Django代理</h3>
            <p>前端 → Django (8000) → Flask (5000)</p>
            <p>✅ 避免跨域问题</p>
            <p>✅ 统一的API接口</p>
            <p>✅ 更安全</p>
        </div>
        
        <h2>测试方法：通过Django代理接口</h2>
        <div class="upload-area" id="uploadArea">
            点击选择图片或拖放到这里<br>
            <small>使用 /api/simple-ocr-upload/ 接口</small>
        </div>
        <input type="file" id="fileInput" accept="image/*" style="display:none;">
        <button onclick="document.getElementById('fileInput').click()">选择图片</button>
        
        <div class="result" id="result">
            识别结果将显示在这里...
        </div>
    </div>
    
    <script>
        console.log('最终测试页面加载完成');
        console.log('当前URL:', window.location.href);
        
        function uploadImage(file) {
            const formData = new FormData();
            formData.append('image', file);
            
            document.getElementById('result').innerHTML = '<p>正在上传图片到Django接口...</p>';
            console.log('开始上传文件:', file.name, '大小:', file.size);
            
            // 使用相对路径调用Django接口
            fetch('/api/simple-ocr-upload/', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('响应状态码:', response.status);
                console.log('响应头:', Object.fromEntries(response.headers.entries()));
                return response.json();
            })
            .then(data => {
                console.log('响应数据:', data);
                
                let html = '<h3>识别结果:</h3>';
                
                if (data.success) {
                    html += `<p class="success">✅ ${data.message}</p>`;
                    html += `<p><strong>订单编号:</strong> ${data.data['订单编号']}</p>`;
                    html += `<p><strong>商品名称:</strong> ${data.data['商品名称']}</p>`;
                    html += `<p><strong>收件人:</strong> ${data.data['收件人']}</p>`;
                    html += `<p><strong>快递单号:</strong> ${data.data['快递单号']}</p>`;
                    html += `<p><strong>物流公司:</strong> ${data.data['物流公司']}</p>`;
                    
                    // 显示处理时间
                    if (data.processing_time) {
                        html += `<p><small>处理时间: ${data.processing_time.toFixed(2)}秒</small></p>`;
                    }
                } else {
                    html += `<p class="error">❌ ${data.error || '识别失败'}</p>`;
                }
                
                document.getElementById('result').innerHTML = html;
            })
            .catch(error => {
                console.error('请求失败:', error);
                document.getElementById('result').innerHTML = 
                    `<p class="error">❌ 上传失败: ${error.message}</p>`;
            });
        }
        
        // 设置文件上传处理
        document.getElementById('fileInput').addEventListener('change', function(e) {
            if (this.files.length > 0) {
                uploadImage(this.files[0]);
            }
        });
        
        // 设置拖放功能
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.background = '#e9f5ff';
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            this.style.background = '';
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.background = '';
            
            if (e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                if (file.type.startsWith('image/')) {
                    uploadImage(file);
                } else {
                    alert('请选择图片文件');
                }
            }
        });
        
        uploadArea.addEventListener('click', function() {
            document.getElementById('fileInput').click();
        });
        
        // 测试Django接口连通性
        console.log('测试Django接口连通性...');
        fetch('/api/check-auth/')
            .then(response => {
                console.log('Django健康检查:', response.ok ? '✅ 正常' : '❌ 异常');
            })
            .catch(error => {
                console.error('Django连接失败:', error);
            });
    </script>
</body>
</html>
