<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5000端口OCR测试</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { background: #f5f5f5; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .upload-area { border: 2px dashed #007bff; padding: 40px; text-align: center; border-radius: 10px; cursor: pointer; margin: 20px 0; }
        .upload-area:hover { background: #e9f5ff; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .result { margin-top: 20px; padding: 20px; background: white; border-radius: 5px; border: 1px solid #ddd; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #6c757d; font-size: 14px; }
    </style>
</head>
<body>
    <h1>5000端口OCR测试</h1>
    <div class="info">端口: 5000 (阿里云安全组已开放)</div>
    
    <div class="container">
        <h2>方法1: 直接Flask OCR接口</h2>
        <p>前端浏览器直接访问Flask服务</p>
        <div class="upload-area" id="uploadArea1">
            点击选择图片<br>
            <small>直接调用: http://101.201.31.24:5000/pic</small>
        </div>
        <input type="file" id="fileInput1" accept="image/*" style="display:none;">
        <button onclick="document.getElementById('fileInput1').click()">选择图片</button>
        
        <h2>方法2: 通过Django代理</h2>
        <p>前端 → Django (8000) → Flask (5000)</p>
        <div class="upload-area" id="uploadArea2">
            点击选择图片<br>
            <small>通过代理: /api/simple-ocr-upload/</small>
        </div>
        <input type="file" id="fileInput2" accept="image/*" style="display:none;">
        <button onclick="document.getElementById('fileInput2').click()">选择图片</button>
        
        <div class="result" id="result">
            识别结果将显示在这里...
        </div>
    </div>
    
    <script>
        console.log('5000端口测试页面加载完成');
        
        // 方法1: 直接调用Flask
        function uploadDirect(file) {
            const formData = new FormData();
            formData.append('image', file);
            
            document.getElementById('result').innerHTML = '<p>正在直接上传到Flask OCR服务 (5000端口)...</p>';
            console.log('直接上传文件:', file.name);
            
            fetch('http://101.201.31.24:5000/pic', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('Flask响应状态码:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Flask响应数据:', data);
                displayResult('直接Flask接口', data);
            })
            .catch(error => {
                console.error('Flask请求失败:', error);
                document.getElementById('result').innerHTML = 
                    `<p class="error">❌ 直接Flask接口失败: ${error.message}</p>`;
            });
        }
        
        // 方法2: 通过Django代理
        function uploadViaDjango(file) {
            const formData = new FormData();
            formData.append('image', file);
            
            document.getElementById('result').innerHTML = '<p>正在通过Django代理上传...</p>';
            console.log('通过Django代理上传文件:', file.name);
            
            fetch('/api/simple-ocr-upload/', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('Django响应状态码:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Django响应数据:', data);
                displayResult('Django代理接口', data);
            })
            .catch(error => {
                console.error('Django请求失败:', error);
                document.getElementById('result').innerHTML = 
                    `<p class="error">❌ Django代理接口失败: ${error.message}</p>`;
            });
        }
        
        function displayResult(source, data) {
            let html = `<h3>${source}结果:</h3>`;
            
            if (data.success) {
                html += `<p class="success">✅ ${data.message}</p>`;
                html += `<p><strong>订单编号:</strong> ${data.data['订单编号']}</p>`;
                html += `<p><strong>商品名称:</strong> ${data.data['商品名称']}</p>`;
                html += `<p><strong>收件人:</strong> ${data.data['收件人']}</p>`;
                html += `<p><strong>快递单号:</strong> ${data.data['快递单号']}</p>`;
                
                if (data.processing_time) {
                    html += `<p><small>处理时间: ${data.processing_time.toFixed(2)}秒</small></p>`;
                }
                
                // 显示方法说明
                if (source.includes('直接')) {
                    html += `<p class="info">✓ 使用5000端口直接访问Flask服务</p>`;
                } else {
                    html += `<p class="info">✓ 通过Django代理访问Flask服务</p>`;
                }
            } else {
                html += `<p class="error">❌ ${data.error || '识别失败'}</p>`;
            }
            
            document.getElementById('result').innerHTML = html;
        }
        
        // 设置文件上传处理
        document.getElementById('fileInput1').addEventListener('change', function(e) {
            if (this.files.length > 0) {
                uploadDirect(this.files[0]);
            }
        });
        
        document.getElementById('fileInput2').addEventListener('change', function(e) {
            if (this.files.length > 0) {
                uploadViaDjango(this.files[0]);
            }
        });
        
        // 设置拖放功能
        document.getElementById('uploadArea1').addEventListener('click', function() {
            document.getElementById('fileInput1').click();
        });
        
        document.getElementById('uploadArea2').addEventListener('click', function() {
            document.getElementById('fileInput2').click();
        });
        
        // 测试服务连通性
        console.log('测试Flask服务连通性...');
        fetch('http://101.201.31.24:5000/health', { mode: 'cors' })
            .then(response => {
                if (response.ok) {
                    console.log('Flask服务健康检查: ✅ 正常 (5000端口)');
                } else {
                    console.log('Flask服务健康检查: ❌ 异常');
                }
            })
            .catch(error => {
                console.error('Flask连接失败:', error);
            });
    </script>
</body>
</html>
